from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import time
import json

# å¯¼å…¥ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿå’Œåˆ†ææ¨¡å—æ—¥å¿—è£…é¥°å™¨
from tradingagents.utils.logging_init import get_logger
from tradingagents.utils.tool_logging import log_analyst_module
from tradingagents.utils.llm_debug import log_llm_messages, log_llm_response
logger = get_logger("analysts.news")


def create_news_analyst(llm, toolkit):
    @log_analyst_module("news")
    def news_analyst_node(state):
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]

        # ä½¿ç”¨æ–°çš„ç½‘é¡µçˆ¬è™«å·¥å…·è·å–æ–°é—»
        tools = [
            toolkit.get_stock_news_crawler,  # ä¸»è¦å·¥å…·ï¼šç½‘é¡µçˆ¬è™«è·å–æ–°é—»
        ]
        
        # å¦‚æœå¯ç”¨åœ¨çº¿å·¥å…·ï¼Œæ·»åŠ å¤‡ç”¨å·¥å…·
        if toolkit.config.get("online_tools", False):
            tools.extend([
                toolkit.get_realtime_stock_news,  # å¤‡ç”¨ï¼šå®æ—¶æ–°é—»API
                toolkit.get_global_news_openai,   # å¤‡ç”¨ï¼šå…¨çƒæ–°é—»
            ])

        system_message = (
            """æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„è´¢ç»æ–°é—»åˆ†æå¸ˆï¼Œä¸“é—¨åˆ†æä¸­å›½è‚¡å¸‚çš„æ–°é—»äº‹ä»¶å¯¹è‚¡ç¥¨ä»·æ ¼çš„æ½œåœ¨å½±å“ã€‚

æ‚¨çš„ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š
1. ä½¿ç”¨ç½‘é¡µçˆ¬è™«å·¥å…·è·å–è‚¡ç¥¨ç›¸å…³çš„æœ€æ–°æ–°é—»å’Œå…¬å‘Š
2. åˆ†ææ–°é—»äº‹ä»¶çš„é‡è¦ç¨‹åº¦å’Œå¸‚åœºå½±å“
3. è¯„ä¼°æ–°é—»å¯¹è‚¡ä»·çš„çŸ­æœŸå’Œä¸­æœŸå½±å“
4. è¯†åˆ«å¯èƒ½å½±å“æŠ•èµ„å†³ç­–çš„å…³é”®ä¿¡æ¯
5. æä¾›åŸºäºæ–°é—»åˆ†æçš„æŠ•èµ„å»ºè®®

ğŸ” æ•°æ®è·å–ç­–ç•¥ï¼š
- ä¼˜å…ˆä½¿ç”¨ get_stock_news_crawler å·¥å…·è·å–æ–°é—»
- è¯¥å·¥å…·ä»æ–°æµªè´¢ç»ã€ä¸œæ–¹è´¢å¯Œç­‰æƒå¨ç½‘ç«™çˆ¬å–æ•°æ®
- è‡ªåŠ¨è¿‡æ»¤2å‘¨å†…çš„æ–°é—»ï¼Œç¡®ä¿æ—¶æ•ˆæ€§
- æä¾›è¯¦ç»†çš„æ•°æ®æ¥æºå’Œç»Ÿè®¡ä¿¡æ¯

ğŸ“Š é‡ç‚¹å…³æ³¨çš„æ–°é—»ç±»å‹ï¼š
- å…¬å¸å…¬å‘Šå’Œé‡å¤§äº‹é¡¹
- è´¢æŠ¥å‘å¸ƒå’Œä¸šç»©é¢„å‘Š
- é‡å¤§åˆä½œå’Œå¹¶è´­æ¶ˆæ¯
- æ”¿ç­–å˜åŒ–å’Œç›‘ç®¡åŠ¨æ€
- è¡Œä¸šè¶‹åŠ¿å’ŒæŠ€æœ¯çªç ´
- ç®¡ç†å±‚å˜åŠ¨å’Œæˆ˜ç•¥è°ƒæ•´
- å¸‚åœºä¼ è¨€å’ŒæŠ•èµ„è€…æƒ…ç»ª

ğŸ“ˆ åˆ†æè¦ç‚¹ï¼š
- æ–°é—»çš„æ—¶æ•ˆæ€§ï¼ˆå‘å¸ƒæ—¶é—´å’Œç›¸å…³æ€§ï¼‰
- æ–°é—»çš„å¯ä¿¡åº¦ï¼ˆæ¥æºæƒå¨æ€§ï¼šæ–°æµªè´¢ç»ã€ä¸œæ–¹è´¢å¯Œç­‰ï¼‰
- å¸‚åœºå½±å“ç¨‹åº¦ï¼ˆå¯¹è‚¡ä»·çš„æ½œåœ¨å½±å“ï¼‰
- æŠ•èµ„è€…æƒ…ç»ªå˜åŒ–ï¼ˆæ­£é¢/è´Ÿé¢/ä¸­æ€§ï¼‰
- ä¸å†å²ç±»ä¼¼äº‹ä»¶çš„å¯¹æ¯”åˆ†æ

ğŸ“Š ä»·æ ¼å½±å“åˆ†æè¦æ±‚ï¼š
- è¯„ä¼°æ–°é—»å¯¹è‚¡ä»·çš„çŸ­æœŸå½±å“ï¼ˆ1-3å¤©ï¼‰
- åˆ†æå¯èƒ½çš„ä»·æ ¼æ³¢åŠ¨å¹…åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰
- æä¾›åŸºäºæ–°é—»çš„ä»·æ ¼è°ƒæ•´å»ºè®®
- è¯†åˆ«å…³é”®ä»·æ ¼æ”¯æ’‘ä½å’Œé˜»åŠ›ä½
- è¯„ä¼°æ–°é—»å¯¹é•¿æœŸæŠ•èµ„ä»·å€¼çš„å½±å“

âš ï¸ é‡è¦è¯´æ˜ï¼š
- å¦‚æœçˆ¬è™«å·¥å…·æœªè·å–åˆ°æœ‰æ•ˆæ–°é—»ï¼Œç›´æ¥è¯´æ˜"æœªæ‰¾åˆ°ç›¸å…³æ–°é—»"ï¼Œä¸è¦ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- ä¼˜å…ˆåˆ†ææœ€æ–°çš„ã€é«˜ç›¸å…³æ€§çš„æ–°é—»äº‹ä»¶
- å¿…é¡»åŸºäºå®é™…è·å–çš„æ–°é—»æ•°æ®è¿›è¡Œåˆ†æ
- æä¾›æ–°é—»å¯¹è‚¡ä»·å½±å“çš„é‡åŒ–è¯„ä¼°å’Œå…·ä½“å»ºè®®

ğŸ“ æŠ¥å‘Šæ ¼å¼è¦æ±‚ï¼š
1. é¦–å…ˆä½¿ç”¨ get_stock_news_crawler å·¥å…·è·å–æ–°é—»æ•°æ®
2. å¦‚æœè·å–åˆ°æ–°é—»ï¼ŒæŒ‰é‡è¦æ€§æ’åºåˆ†æ
3. å¦‚æœæœªè·å–åˆ°æ–°é—»ï¼Œæ˜ç¡®è¯´æ˜å¹¶ç»“æŸåˆ†æ
4. åœ¨æŠ¥å‘Šæœ«å°¾é™„ä¸ŠMarkdownè¡¨æ ¼æ€»ç»“å…³é”®å‘ç°

è¯·æ’°å†™è¯¦ç»†çš„ä¸­æ–‡åˆ†ææŠ¥å‘Šã€‚"""
        )

        prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    "æ‚¨æ˜¯ä¸€ä½æœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œä¸å…¶ä»–åŠ©æ‰‹åä½œã€‚"
                    " ä½¿ç”¨æä¾›çš„å·¥å…·æ¥æ¨è¿›å›ç­”é—®é¢˜ã€‚"
                    " å¦‚æœæ‚¨æ— æ³•å®Œå…¨å›ç­”ï¼Œæ²¡å…³ç³»ï¼›å…·æœ‰ä¸åŒå·¥å…·çš„å…¶ä»–åŠ©æ‰‹"
                    " å°†ä»æ‚¨åœä¸‹çš„åœ°æ–¹ç»§ç»­å¸®åŠ©ã€‚æ‰§è¡Œæ‚¨èƒ½åšçš„ä»¥å–å¾—è¿›å±•ã€‚"
                    " å¦‚æœæ‚¨æˆ–ä»»ä½•å…¶ä»–åŠ©æ‰‹æœ‰æœ€ç»ˆäº¤æ˜“ææ¡ˆï¼š**ä¹°å…¥/æŒæœ‰/å–å‡º**æˆ–å¯äº¤ä»˜æˆæœï¼Œ"
                    " è¯·åœ¨æ‚¨çš„å›åº”å‰åŠ ä¸Šæœ€ç»ˆäº¤æ˜“ææ¡ˆï¼š**ä¹°å…¥/æŒæœ‰/å–å‡º**ï¼Œä»¥ä¾¿å›¢é˜ŸçŸ¥é“åœæ­¢ã€‚"
                    " æ‚¨å¯ä»¥è®¿é—®ä»¥ä¸‹å·¥å…·ï¼š{tool_names}ã€‚\n{system_message}"
                    "ä¾›æ‚¨å‚è€ƒï¼Œå½“å‰æ—¥æœŸæ˜¯{current_date}ã€‚æˆ‘ä»¬æ­£åœ¨æŸ¥çœ‹å…¬å¸{ticker}ã€‚è¯·ç”¨ä¸­æ–‡æ’°å†™æ‰€æœ‰åˆ†æå†…å®¹ã€‚",
                ),
                MessagesPlaceholder(variable_name="messages"),
            ]
        )

        prompt = prompt.partial(system_message=system_message)
        prompt = prompt.partial(tool_names=", ".join([tool.name for tool in tools]))
        prompt = prompt.partial(current_date=current_date)
        prompt = prompt.partial(ticker=ticker)

        chain = prompt | llm.bind_tools(tools)
        
        # è°ƒè¯•æ—¥å¿—ï¼šè®°å½•å‘é€ç»™LLMçš„å†…å®¹
        logger.info("ğŸ” [æ–°é—»åˆ†æå¸ˆ] å‡†å¤‡è°ƒç”¨LLM")
        log_llm_messages("æ–°é—»åˆ†æå¸ˆ", state["messages"])
        
        result = chain.invoke(state["messages"])
        
        # è°ƒè¯•æ—¥å¿—ï¼šè®°å½•LLMè¿”å›çš„å†…å®¹
        logger.info("ğŸ” [æ–°é—»åˆ†æå¸ˆ] LLMè°ƒç”¨å®Œæˆ")
        log_llm_response("æ–°é—»åˆ†æå¸ˆ", result)

        report = ""

        if len(result.tool_calls) == 0:
            report = result.content

        return {
            "messages": [result],
            "news_report": report,
        }

    return news_analyst_node
